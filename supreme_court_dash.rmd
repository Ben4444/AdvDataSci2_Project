---
title: "Supreme Court Decisions"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: scroll
    theme: spacelab
runtime: shiny
---
```{r setup, include=FALSE}
#rsconnect::setAccountInfo(name='jhubiostatistics',
#                          token='41969E2AC0F047B42111176450B2ADB8',
#                          secret='vzjG1Ab7kdLIzR7mFTQW3uJdJnzhcsv5NBcanzXs')

library(flexdashboard)
library(shiny)
library(ggplot2)
library(lubridate)
library(RColorBrewer)
library(magrittr)
library(dplyr)

dat <- readRDS("full.rds")



dat$decided<- as.Date(dat$decided,format="%B %d, %Y")
dat$datesen<- as.Date(dat$datesen,format="%m/%d/%Y")
topic_list <- unique(dat$topic)
justice_list <- unique(dat$name)

#making birthplace list 

for(i in 1:length(dat$birthst)){
if(dat$birthst[i] %in% c(19,21,39,7,29,45,32,38,30,8,20,51)){
  dat$region[i]<- "Northeast"
} else if(dat$birthst[i] %in% c(48,46,17,42,33,40,10,1,24,4,18,9)){
  dat$region[i]<-"Southeast"
}else if(dat$birthst[i] %in% c(35,14,22,13,25,49,23,15,16,27,41,34)){
  dat$region[i]<- "Midwest"
}else if(dat$birthst[i] %in% c(43,36,31,3)){
  dat$region[i]<- "Southwest"
}else if (dat$birthst[i] %in% c(6,50,26,12,47,37,44,28,5,2,11)){
  dat$region[i]<-"West"
}else if(dat$birthst[i] %in% c(52,53,54,55,56,57,58)){
  dat$region[i]<-"International"
}
}
region_list<- unique(dat$region)

#making the socioeconomic status list

for(i in 1:length(dat$famses)){
if(!is.na(dat$famses[i])&dat$famses[i] == 1){
  dat$famses[i]<- "Lower"
}else if (!is.na(dat$famses[i])&dat$famses[i] %in% c(2,3,4)){
  dat$famses[i]<- "Middle"
}else if(!is.na(dat$famses[i])&dat$famses[i] == 5){
  dat$famses[i]<-"Upper"
}else{
  dat$famses[i]<- "Unknown"
}
}

ses_list<-unique(dat$famses)

party_list <- unique(dat_sub$pres_party)
religion_list <- unique(dat_sub$religion)
```

By Topic
=======================================================================

Column {.sidebar}
-----------------------------------------------------------------------

#### Set Parameters
```{r}
selectInput("topic", label = "Topic:",
            choices = topic_list, selected = NULL, multiple = T)
```

Row
-----------------------------------------------------------------------

```{r}
renderPlot({
  ggplot(dat) + 
    geom_bar(aes(x = reorder(topic, -table(topic)[topic]))) + 
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
    scale_y_continuous(expand = c(0,5)) + 
    labs(x = "Topic", y = "No. Cases")
})
```


Row
-----------------------------------------------------------------------

```{r}
renderPlot({
  req(!is.null(input$topic))
  
  dat_subset <- dat[dat$topic %in% input$topic, c("opinion","topic")]
  melted_df <- as.data.frame(table(dat_subset))
  
  palette = scale_fill_brewer(palette = "Set1")
  if(length(unique(dat_subset$opinion)) > 9){ 
       palette = scale_fill_manual(values = colorRampPalette(colors=brewer.pal(9, "Set1"))(length(unique(dat_subset$opinion))))
  }
  
for(j in input$topic){
  melted_df[melted_df$topic == j,"percent"] <- melted_df[melted_df$topic == j,"Freq"]*100 / sum(melted_df[melted_df$topic == j,"Freq"])
}
  
  ggplot(melted_df) + 
    geom_col(aes(x = reorder(topic, -table(topic)[topic]), y = percent, fill = opinion)) + 
    theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "bottom") + 
    scale_y_continuous(limits = c(0, NA),expand = c(0,0)) + 
    labs(x = "Topic", y = "No. Cases", fill = "Justice\nDelivering\nOpinion") +
    palette
})
```

By Justice
================================================================

Column {.sidebar}
----------------------------------------------------------------

#### Set Parameters
```{r}
selectInput("justice", label = "Justice:",
            choices = justice_list, selected = NULL, multiple = T)
```

Row
-----------------------------------------------------------------------

```{r}
renderPlot({
  ggplot(dat) + 
    geom_bar(aes(x = reorder(opinion, datesen))) + 
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
    scale_y_continuous(expand = c(0,5)) + 
    labs(x = "Justice", y = "No. Times Justice Delivered Opinion")
})
```

Row
-----------------------------------------------------------------------

```{r}
renderPlot({
  req(!is.null(input$justice))
  
  palette = scale_fill_brewer(palette = "Set1")
  if(length(input$justice) > 9){ 
       palette = scale_fill_manual(values = colorRampPalette(colors=brewer.pal(9, "Set1"))(length(input$justice)))
  }
  
  dat_subset <- dat[dat$opinion %in% input$justice, c("opinion", "topic")]
  melted_df <- as.data.frame(table(dat_subset))
  ggplot(melted_df) + 
    geom_col(aes(x = topic, y = Freq, fill = opinion), position = "dodge") + 
    theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "bottom", panel.background = element_blank(), axis.line = element_line(), panel.grid.major.y = element_line(color = "grey90")) +
    scale_y_continuous(limits = c(NA,NA),expand = c(0,0)) +
    geom_text(aes(x = 1,y=Freq + 1, label="")) +
    labs(x = "Topic", y = "No. Cases", fill = "Justice Delivering Opinion") +
    palette
})
```

Birth Region and Family's Socioeconomic Status
================================================================

Column {.sidebar}
----------------------------------------------------------------

#### Set Parameters
```{r}
selectInput("Birth_Region", "Birth Region:",
            choices =region_list, selected = NULL, multiple = T)

selectInput("Family_Socioeconomic_Status", label ="Family's Socioeconomic Status",choices= ses_list, selected = NULL, multiple = T)
```

Row
-----------------------------------------------------------------------

```{r}
renderPlot({
unique_justices_dat<- dat[!duplicated(dat$name),] 

plot<-ggplot(unique_justices_dat%>% count(region,famses), aes(region,n,fill=famses))
plot+geom_bar(stat="identity")+labs(y="Number of Justices",x="Region of Birth")+guides(fill=guide_legend(title="Family's Socioeconomic Status"))

})
```

Row
-----------------------------------------------------------------------

```{r}
renderPlot({
 if(!is.null(input$Birth_Region) & is.null(input$Family_Socioeconomic_Status)){
  

  dat_subset <- dat[dat$region %in% c(input$Birth_Region),]
  
  ggplot(dat_subset %>% count(topic,famses),aes(topic,n,fill=famses))+geom_bar(
    stat="identity")+labs(,y="Number of opinions written",x="Topic")+guides(fill=guide_legend(title="Family's Socioeconomic Status"))+theme(axis.text.x = element_text(size=5,angle = 45, hjust = 1),legend.position=c(0.9,0.85))
  
 }else if (is.null(input$Birth_Region) & !is.null(input$Family_Socioeconomic_Status)){
   dat_subset_1<- dat[dat$famses %in% c(input$Family_Socioeconomic_Status),]
   
   ggplot(dat_subset_1 %>% count(topic,region),aes(topic,n,fill=region))+geom_bar(
    stat="identity")+labs(y="Number of opinions written",x="Topic")+guides(fill=guide_legend(title="Region of Birth"))+theme(axis.text.x = element_text(size=5,angle = 45, hjust = 1),legend.position=c(0.9,0.85))
 }else if (!is.null(input$Birth_Region) & !is.null(input$Family_Socioeconomic_Status)){
   
   dat_subset_2<- dat[dat$region %in% c(input$Birth_Region),]
   dat_subset_3<- dat_subset_2[dat_subset_2$famses %in% c(input$Family_Socioeconomic_Status),]
   
   ggplot(dat_subset_3 %>% count(topic),aes(topic,n))+geom_bar(stat="identity")+labs(y="Number of opinions written",x="Topic")+theme(axis.text.x = element_text(size=5,angle = 45, hjust = 1),legend.position=c(0.9,0.85))
 }
})
```